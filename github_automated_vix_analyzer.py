#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
GitHub Actions Automated VIX Analysis System
Êó•ÁµåVI„Å™„Åó„ÅßVIX„ÉªÊó•Áµå„ÉªS&P500„ÅÆ„Åø„ÅßÈ´òÂ∫¶ÂàÜÊûê
"""

import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import json
from datetime import datetime, timedelta
import warnings
from arch import arch_model
import os

warnings.filterwarnings('ignore')

class GitHubVIXAnalyzer:
    def __init__(self):
        self.data = None
        self.garch_model = None
        self.risk_score = 0
        self.risk_level = ""
        
    def download_data(self, period='1y'):
        """„Éá„Éº„ÇøÂèñÂæóÔºàÊó•ÁµåVI„Å™„ÅóÔºâ"""
        print("üìä Â∏ÇÂ†¥„Éá„Éº„ÇøÂèñÂæó‰∏≠...")
        
        # VIX, Êó•Áµå, S&P500„ÅÆ„Åø
        vix = yf.download('^VIX', period=period, auto_adjust=True, threads=True)
        nikkei = yf.download('^N225', period=period, auto_adjust=True, threads=True)
        sp500 = yf.download('^GSPC', period=period, auto_adjust=True, threads=True)
        
        if vix.empty or nikkei.empty or sp500.empty:
            raise ValueError("„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü")
        
        # „Éá„Éº„Çø„Éï„É¨„Éº„É†ÊßãÁØâ
        data = pd.DataFrame(index=vix.index)
        data['VIX'] = vix['Close']
        data['Nikkei'] = nikkei['Close']
        data['SP500'] = sp500['Close']
        
        # „É™„Çø„Éº„É≥Ë®àÁÆó
        data['Nikkei_Returns'] = data['Nikkei'].pct_change()
        data['SP500_Returns'] = data['SP500'].pct_change()
        data['VIX_Returns'] = data['VIX'].pct_change()
        
        # ÂÆüÁèæ„Éú„É©„ÉÜ„Ç£„É™„ÉÜ„Ç£Ë®àÁÆóÔºàÊó•ÁµåVI‰ª£ÊõøÔºâ
        data['Nikkei_RV_5d'] = data['Nikkei_Returns'].rolling(5).std() * np.sqrt(252) * 100
        data['Nikkei_RV_20d'] = data['Nikkei_Returns'].rolling(20).std() * np.sqrt(252) * 100
        
        # VIX vs ÂÆüÁèæ„Éú„É© „Çπ„Éó„É¨„ÉÉ„Éâ
        data['VIX_RV_Spread'] = data['VIX'] - data['Nikkei_RV_20d']
        
        # Áõ∏ÂØæÁöÑÂº∑Âº±
        data['Nikkei_SP500_Ratio'] = data['Nikkei'] / data['SP500']
        data['Ratio_MA20'] = data['Nikkei_SP500_Ratio'].rolling(20).mean()
        data['Ratio_Deviation'] = data['Nikkei_SP500_Ratio'] - data['Ratio_MA20']
        
        self.data = data.dropna()
        print(f"‚úÖ „Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü: {len(self.data)}Êó•ÂàÜ")
        return self.data
    
    def fit_garch_model(self):
        """GARCH(1,1)„É¢„Éá„É´Êé®ÂÆö"""
        print("üî¨ GARCH(1,1)„É¢„Éá„É´Êé®ÂÆö‰∏≠...")
        
        returns = self.data['Nikkei_Returns'].dropna() * 100
        
        try:
            self.garch_model = arch_model(returns, vol='Garch', p=1, q=1, 
                                         mean='Constant', dist='normal')
            garch_result = self.garch_model.fit(disp='off')
            
            conditional_vol = garch_result.conditional_volatility
            self.data['GARCH_Vol'] = np.nan
            self.data.loc[conditional_vol.index, 'GARCH_Vol'] = conditional_vol
            self.data['GARCH_Vol_Annualized'] = self.data['GARCH_Vol'] * np.sqrt(252)
            
            print(f"‚úÖ GARCHÊé®ÂÆöÂÆå‰∫Ü - ÁèæÂú®‰∫àÊ∏¨„Éú„É©: {self.data['GARCH_Vol_Annualized'].iloc[-1]:.2f}%")
            return garch_result
        except Exception as e:
            print(f"‚ö†Ô∏è GARCHÊé®ÂÆöÂ§±Êïó: {e}")
            return None
    
    def calculate_risk_indicators(self):
        """„É™„Çπ„ÇØÊåáÊ®ôË®àÁÆó"""
        print("üìä „É™„Çπ„ÇØÊåáÊ®ôË®àÁÆó‰∏≠...")
        
        # VIXÊåáÊ®ô
        self.data['VIX_MA20'] = self.data['VIX'].rolling(20).mean()
        self.data['VIX_Spike'] = self.data['VIX'] > (self.data['VIX_MA20'] + self.data['VIX'].rolling(20).std())
        
        # „Éú„É©„ÉÜ„Ç£„É™„ÉÜ„Ç£„Éª„É¨„Ç∏„Éº„É†
        if 'GARCH_Vol_Annualized' in self.data.columns:
            garch_quantiles = self.data['GARCH_Vol_Annualized'].quantile([0.33, 0.67])
            self.data['Vol_Regime'] = np.where(
                self.data['GARCH_Vol_Annualized'] > garch_quantiles[0.67], 'High',
                np.where(self.data['GARCH_Vol_Annualized'] < garch_quantiles[0.33], 'Low', 'Medium')
            )
        
        # Áõ∏ÂØæÂº∑Âº±ÈÅéÁÜ±
        self.data['Ratio_Extreme'] = abs(self.data['Ratio_Deviation']) > self.data['Ratio_Deviation'].std() * 2
        
        print("‚úÖ „É™„Çπ„ÇØÊåáÊ®ôË®àÁÆóÂÆå‰∫Ü")
    
    def generate_signals(self):
        """„Ç∑„Ç∞„Éä„É´ÁîüÊàê"""
        print("üö® „Ç∑„Ç∞„Éä„É´ÁîüÊàê‰∏≠...")
        
        # Ë≠¶ÂëäÊù°‰ª∂
        vix_elevated = self.data['VIX'] > 25
        vix_rv_spread_high = self.data['VIX_RV_Spread'] > self.data['VIX_RV_Spread'].quantile(0.8)
        ratio_extreme = self.data['Ratio_Extreme']
        
        if 'Vol_Regime' in self.data.columns:
            vol_regime_high = self.data['Vol_Regime'] == 'High'
        else:
            vol_regime_high = pd.Series(False, index=self.data.index)
        
        # Ë§áÂêà„Ç∑„Ç∞„Éä„É´
        signal_count = (vix_elevated.astype(int) + 
                       vix_rv_spread_high.astype(int) + 
                       ratio_extreme.astype(int) + 
                       vol_regime_high.astype(int))
        
        self.data['Warning_Signal'] = signal_count >= 2
        self.data['Crash_Signal'] = signal_count >= 3
        
        print("‚úÖ „Ç∑„Ç∞„Éä„É´ÁîüÊàêÂÆå‰∫Ü")
    
    def calculate_risk_score(self):
        """Á∑èÂêà„É™„Çπ„ÇØ„Çπ„Ç≥„Ç¢Ë®àÁÆó"""
        latest = self.data.iloc[-1]
        
        # ÂêÑÊåáÊ®ô„ÅÆ„Çπ„Ç≥„Ç¢Ë®àÁÆó (0-100)
        vix_score = min(latest['VIX'] / 40 * 100, 100)
        
        if 'GARCH_Vol_Annualized' in self.data.columns:
            garch_score = min(latest['GARCH_Vol_Annualized'] / 30 * 100, 100)
        else:
            garch_score = min(latest['Nikkei_RV_20d'] / 30 * 100, 100)
        
        spread_score = min(abs(latest['VIX_RV_Spread']) / 15 * 100, 100)
        ratio_score = min(abs(latest['Ratio_Deviation']) * 1000, 100)
        
        # Á∑èÂêà„Çπ„Ç≥„Ç¢
        self.risk_score = (vix_score + garch_score + spread_score + ratio_score) / 4
        
        # „É¨„Éô„É´Âà§ÂÆö
        if self.risk_score > 70:
            self.risk_level = "üî¥ HIGH RISK"
        elif self.risk_score > 40:
            self.risk_level = "üü° MEDIUM RISK"
        else:
            self.risk_level = "üü¢ LOW RISK"
        
        print(f"üéØ „É™„Çπ„ÇØ„Çπ„Ç≥„Ç¢: {self.risk_score:.1f}/100 - {self.risk_level}")
        
        return {
            'total_score': self.risk_score,
            'level': self.risk_level,
            'vix_score': vix_score,
            'volatility_score': garch_score,
            'spread_score': spread_score,
            'ratio_score': ratio_score
        }
    
    def create_dashboard(self, save_path="docs"):
        """GitHub PagesÁî®„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰ΩúÊàê"""
        print("üìà GitHub PagesÁî®„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰ΩúÊàê‰∏≠...")
        
        # „Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
        os.makedirs(save_path, exist_ok=True)
        
        # Plotly „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        fig = make_subplots(
            rows=3, cols=2,
            subplot_titles=[
                'VIX Fear Index Overview',
                'Risk Score Dashboard',
                'VIX vs Realized Volatility',
                'Nikkei vs SP500 Relative Strength',
                'Signal History',
                'Current Risk Assessment'
            ],
            specs=[[{"secondary_y": False}, {"secondary_y": False}],
                   [{"secondary_y": False}, {"secondary_y": False}],
                   [{"secondary_y": False}, {"secondary_y": False}]]
        )
        
        # 1. VIX Overview
        fig.add_trace(
            go.Scatter(x=self.data.index, y=self.data['VIX'],
                      name='VIXÊÅêÊÄñÊåáÊï∞', line=dict(color='red', width=3)),
            row=1, col=1
        )
        
        # VIX „É¨„Éô„É´ÂèÇËÄÉÁ∑ö„ÇíËøΩÂä†
        fig.add_hline(y=20, line_dash="dash", line_color="orange", 
                     annotation_text="Ë≠¶ÊàíÊ∞¥Ê∫ñ(20)", row=1, col=1)
        fig.add_hline(y=30, line_dash="dash", line_color="red", 
                     annotation_text="È´òË≠¶ÊàíÊ∞¥Ê∫ñ(30)", row=1, col=1)
        
        # 2. Risk Score (Bar Chart‰ª£Êõø)
        latest = self.data.iloc[-1]
        risk_data = self.calculate_risk_score()
        
        risk_components = ['VIX Score', 'Vol Score', 'Spread Score', 'Ratio Score']
        risk_values = [risk_data['vix_score'], risk_data['volatility_score'], 
                      risk_data['spread_score'], risk_data['ratio_score']]
        
        fig.add_trace(
            go.Bar(x=risk_components, y=risk_values,
                   name='„É™„Çπ„ÇØ„Çπ„Ç≥„Ç¢ÊßãÊàê',
                   marker_color=['red' if v > 70 else 'orange' if v > 40 else 'green' for v in risk_values]),
            row=1, col=2
        )
        
        # Total Risk Score „ÇíÊ≥®Èáà„ÅßË°®Á§∫
        fig.add_annotation(
            text=f"<b>Total Risk: {self.risk_score:.1f}/100</b><br>{self.risk_level}",
            xref="x domain", yref="y domain",
            x=0.5, y=0.9,
            xanchor="center", yanchor="top",
            showarrow=False,
            font=dict(size=16, color="red" if self.risk_score > 70 else "orange" if self.risk_score > 40 else "green"),
            bgcolor="rgba(255,255,255,0.8)",
            row=1, col=2
        )
        
        # 3. VIX vs RV
        if 'GARCH_Vol_Annualized' in self.data.columns:
            fig.add_trace(
                go.Scatter(x=self.data.index, y=self.data['GARCH_Vol_Annualized'],
                          name='GARCH‰∫àÊ∏¨„Éú„É©', line=dict(color='blue')),
                row=2, col=1
            )
        
        fig.add_trace(
            go.Scatter(x=self.data.index, y=self.data['Nikkei_RV_20d'],
                      name='ÂÆüÁèæ„Éú„É©20Êó•', line=dict(color='green')),
            row=2, col=1
        )
        
        # 4. Relative Strength
        fig.add_trace(
            go.Scatter(x=self.data.index, y=self.data['Nikkei_SP500_Ratio'],
                      name='Êó•Áµå/SP500ÊØîÁéá', line=dict(color='purple')),
            row=2, col=2
        )
        
        # 5. Signals
        warning_dates = self.data[self.data['Warning_Signal']].index
        crash_dates = self.data[self.data['Crash_Signal']].index
        
        fig.add_trace(
            go.Scatter(x=self.data.index, y=self.data['VIX'],
                      name='VIX', line=dict(color='black')),
            row=3, col=1
        )
        
        if len(warning_dates) > 0:
            fig.add_trace(
                go.Scatter(x=warning_dates, y=self.data.loc[warning_dates, 'VIX'],
                          mode='markers', name='Ë≠¶Âëä„Ç∑„Ç∞„Éä„É´',
                          marker=dict(color='orange', size=8)),
                row=3, col=1
            )
        
        if len(crash_dates) > 0:
            fig.add_trace(
                go.Scatter(x=crash_dates, y=self.data.loc[crash_dates, 'VIX'],
                          mode='markers', name='„ÇØ„É©„ÉÉ„Ç∑„É•„Ç∑„Ç∞„Éä„É´',
                          marker=dict(color='red', size=10, symbol='triangle-down')),
                row=3, col=1
            )
        
        # 6. Current Assessment
        current_metrics = {
            'VIX': latest['VIX'],
            'Nikkei RV': latest['Nikkei_RV_20d'],
            'VIX/RV Spread': latest['VIX_RV_Spread']
        }
        
        fig.add_trace(
            go.Bar(x=list(current_metrics.keys()), y=list(current_metrics.values()),
                   name='ÁèæÂú®„ÅÆÊåáÊ®ô'),
            row=3, col=2
        )
        
        # „É¨„Ç§„Ç¢„Ç¶„Éà
        fig.update_layout(
            height=1000,
            title_text="<b>üî¨ Automated VIX Risk Analysis Dashboard</b>",
            title_font_size=24,
            showlegend=True
        )
        
        # „Ç¶„Ç©„Éº„Çø„Éº„Éû„Éº„ÇØ
        fig.add_annotation(
            text="@pyon - Automated Analysis",
            xref="paper", yref="paper",
            x=0.02, y=0.02,
            showarrow=False,
            font=dict(size=24, color="rgba(128,128,128,0.7)"),
            align="left"
        )
        
        # HTML‰øùÂ≠ò
        html_file = os.path.join(save_path, "index.html")
        fig.write_html(html_file)
        print(f"‚úÖ „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰øùÂ≠ò: {html_file}")
        
        return html_file
    
    def generate_json_report(self, save_path="docs"):
        """JSON „É¨„Éù„Éº„ÉàÁîüÊàê"""
        latest = self.data.iloc[-1]
        latest_date = self.data.index[-1].strftime('%Y-%m-%d')
        
        risk_data = self.calculate_risk_score()
        
        report = {
            "timestamp": datetime.now().isoformat(),
            "analysis_date": latest_date,
            "risk_assessment": {
                "total_score": round(self.risk_score, 1),
                "level": self.risk_level,
                "components": {
                    "vix_score": round(risk_data['vix_score'], 1),
                    "volatility_score": round(risk_data['volatility_score'], 1),
                    "spread_score": round(risk_data['spread_score'], 1),
                    "ratio_score": round(risk_data['ratio_score'], 1)
                }
            },
            "current_metrics": {
                "vix": round(latest['VIX'], 2),
                "nikkei": round(latest['Nikkei'], 2),
                "sp500": round(latest['SP500'], 2),
                "nikkei_rv_20d": round(latest['Nikkei_RV_20d'], 2),
                "vix_rv_spread": round(latest['VIX_RV_Spread'], 2),
                "nikkei_sp500_ratio": round(latest['Nikkei_SP500_Ratio'], 4)
            },
            "signals": {
                "warning_signal": int(latest['Warning_Signal']),
                "crash_signal": int(latest['Crash_Signal'])
            },
            "alert_required": bool(self.risk_score > 60 or latest['Crash_Signal'])
        }
        
        # JSON‰øùÂ≠ò
        os.makedirs(save_path, exist_ok=True)
        json_file = os.path.join(save_path, "risk_report.json")
        with open(json_file, 'w', encoding='utf-8') as f:
            json.dump(report, f, ensure_ascii=False, indent=2)
        
        print(f"‚úÖ JSON„É¨„Éù„Éº„Éà‰øùÂ≠ò: {json_file}")
        return report

def main():
    """„É°„Ç§„É≥ÂÆüË°åÈñ¢Êï∞"""
    analyzer = GitHubVIXAnalyzer()
    
    # „Éá„Éº„ÇøÂèñÂæó„ÉªÂàÜÊûê
    analyzer.download_data(period='1y')
    analyzer.fit_garch_model()
    analyzer.calculate_risk_indicators()
    analyzer.generate_signals()
    
    # „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Éª„É¨„Éù„Éº„Éà‰ΩúÊàê
    analyzer.create_dashboard()
    report = analyzer.generate_json_report()
    
    # ÁµêÊûúË°®Á§∫
    print(f"\n{'='*50}")
    print(f"üî¨ AUTOMATED VIX ANALYSIS REPORT")
    print(f"{'='*50}")
    print(f"üìÖ ÂàÜÊûêÊó•: {report['analysis_date']}")
    print(f"üéØ „É™„Çπ„ÇØ„Çπ„Ç≥„Ç¢: {report['risk_assessment']['total_score']}/100")
    print(f"üìä „É™„Çπ„ÇØ„É¨„Éô„É´: {report['risk_assessment']['level']}")
    print(f"üö® „Ç¢„É©„Éº„ÉàÂøÖË¶Å: {'YES' if report['alert_required'] else 'NO'}")
    print(f"{'='*50}")
    
    return analyzer, report

if __name__ == "__main__":
    analyzer, report = main()